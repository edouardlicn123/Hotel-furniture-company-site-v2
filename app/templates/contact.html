{% extends "base.html" %}

{% block title %}Contact Us - {{ settings.company_name or 'Hotel Furniture Manufacturer' }}{% endblock %}

{% block hero_section %}
    {% set hero_title = "Contact Us" %}
    {% set hero_subtitle = "Get in touch for custom quotes, project collaboration, or factory visit arrangements." %}
    {% include 'partials/hero_small.html' %}
{% endblock %}


{% block content %}
<div class="container my-5">
    <div class="row g-5 justify-content-center">
        <!-- Left: Contact Information -->
        <div class="col-lg-5">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body p-4 p-lg-5">
                    <h3 class="card-title mb-4">Contact Information</h3>

                    {% set phones = [settings.phone1, settings.phone2, settings.phone3] | select | list %}
                    {% if phones %}
                    <p class="mb-3">
                        <i class="bi bi-telephone-fill me-2 text-primary"></i>
                        <strong>Phone:</strong><br>
                        {{ phones | join('<br>') | safe }}
                    </p>
                    {% endif %}

                    {% set emails = [settings.email1, settings.email2, settings.email3] | select | list %}
                    {% if emails %}
                    <p class="mb-3">
                        <i class="bi bi-envelope-fill me-2 text-primary"></i>
                        <strong>Email:</strong><br>
                        {{ emails | join('<br>') | safe }}
                    </p>
                    {% endif %}

                    {% set whatsapps = [settings.whatsapp1, settings.whatsapp2] | select | list %}
                    {% if whatsapps %}
                    <p class="mb-3">
                        <i class="bi bi-whatsapp me-2 text-success"></i>
                        <strong>WhatsApp:</strong><br>
                        {{ whatsapps | join('<br>') | safe }}
                    </p>
                    {% endif %}

                    {% set wechats = [settings.wechat1, settings.wechat2] | select | list %}
                    {% if wechats %}
                    <p class="mb-3">
                        <i class="bi bi-wechat me-2 text-success"></i>
                        <strong>WeChat:</strong><br>
                        {{ wechats | join('<br>') | safe }}
                    </p>
                    {% endif %}

                    {% if settings.fax %}
                    <p class="mb-3">
                        <i class="bi bi-printer-fill me-2 text-muted"></i>
                        <strong>Fax:</strong><br>
                        {{ settings.fax }}
                    </p>
                    {% endif %}

                    {% if settings.address %}
                    <p class="mb-3">
                        <i class="bi bi-geo-alt-fill me-2 text-danger"></i>
                        <strong>Address:</strong><br>
                        {{ settings.address | replace('\n', '<br>') | safe }}
                    </p>
                    {% endif %}

                    {% if not (phones or emails or whatsapps or wechats or settings.fax or settings.address) %}
                    <p class="text-muted fst-italic">Contact details will be updated soon.<br>Please use the form on the right.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Right: Message Form -->
        <div class="col-lg-7">
            <div class="card shadow-sm border-0">
                <div class="card-body p-4 p-lg-5">
                    <h3 class="card-title mb-4">Send Message</h3>
                    <p class="text-muted mb-4">Please fill out the form below. We aim to respond within 24 business hours.</p>

                    <form id="contact-form" novalidate>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="contact-name" class="form-label">Your Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="contact-name" required placeholder="John Doe">
                            </div>
                            <div class="col-md-6">
                                <label for="contact-email" class="form-label">Email Address <span class="text-danger">*</span></label>
                                <input type="email" class="form-control" id="contact-email" required placeholder="your@email.com">
                            </div>
                        </div>

                        <div class="row g-3 mt-2">
                            <div class="col-md-6">
                                <label for="contact-whatsapp" class="form-label">WhatsApp / Phone</label>
                                <input type="tel" class="form-control" id="contact-whatsapp" placeholder="+86 123 4567 8900">
                            </div>
                            <div class="col-md-6">
                                <label for="contact-subject" class="form-label">Subject <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="contact-subject" required placeholder="Inquiry about custom hotel furniture">
                            </div>
                        </div>

                        <div class="mt-3">
                            <label for="contact-message" class="form-label">Message <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="contact-message" rows="6" required 
                                      placeholder="Please describe your project needs, quantity, specifications, or any questions..."></textarea>
                        </div>

                        <!-- Verification Code -->
                        <div class="mt-4">
                            <label class="form-label">Verification Code <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="verification-input" 
                                       placeholder="Enter 4-digit code" maxlength="4" required>
                                <span class="input-group-text p-0" style="width:140px; overflow:hidden;">
                                    <canvas id="verification-canvas" width="140" height="44"></canvas>
                                </span>
                            </div>
                            <div class="mt-2 d-flex align-items-center gap-3">
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="refresh-verification">
                                    <i class="bi bi-arrow-repeat me-1"></i>Refresh
                                </button>
                                <small class="text-muted">Type the code shown in the image</small>
                            </div>
                        </div>

                        <div class="mt-5 text-center">
                            <button type="submit" id="send-contact-btn" class="btn btn-primary btn-lg px-5 py-3">
                                <span class="spinner-border spinner-border-sm d-none me-2" role="status"></span>
                                Send Message
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1090;"></div>

<script>
// ==================== Config ====================
const COOLDOWN_KEY = 'lastContactSendTime';
const COOLDOWN_MS = 120 * 1000; // 120 seconds
let verificationCode = '';

// ==================== Toast Helper ====================
function showToast(message, type = 'success') {
    const container = document.querySelector('.toast-container');
    const toastEl = document.createElement('div');
    toastEl.className = `toast align-items-center text-white bg-${type} border-0 shadow`;
    toastEl.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    container.appendChild(toastEl);

    const bsToast = new bootstrap.Toast(toastEl, { delay: 6000 });
    bsToast.show();

    toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
}

// ==================== Verification Code Generator ====================
function generateVerificationCode() {
    verificationCode = Math.floor(1000 + Math.random() * 9000).toString();
    
    const canvas = document.getElementById('verification-canvas');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    ctx.fillStyle = '#f8f9fa';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Interference lines
    for (let i = 0; i < 7; i++) {
        ctx.beginPath();
        ctx.moveTo(Math.random()*canvas.width, Math.random()*canvas.height);
        ctx.lineTo(Math.random()*canvas.width, Math.random()*canvas.height);
        ctx.strokeStyle = `rgba(0,0,0,${0.15 + Math.random()*0.25})`;
        ctx.lineWidth = 1.3;
        ctx.stroke();
    }
    
    // Text with distortion
    ctx.font = 'bold 32px Arial';
    ctx.textBaseline = 'middle';
    for (let i = 0; i < verificationCode.length; i++) {
        const x = 18 + i * 30;
        const y = 22 + (Math.random()*10 - 5);
        const rot = (Math.random()*40 - 20) * Math.PI / 180;
        
        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(rot);
        ctx.fillStyle = ['#1a3c5e','#2c5282','#34495e','#5a7d9c'][Math.floor(Math.random()*4)];
        ctx.fillText(verificationCode[i], -12, 0);
        ctx.restore();
    }
    
    // Noise dots
    for (let i = 0; i < 50; i++) {
        ctx.fillStyle = `rgba(0,0,0,${Math.random()*0.35})`;
        ctx.fillRect(Math.random()*canvas.width, Math.random()*canvas.height, 1.8, 1.8);
    }
}

// ==================== Event Listeners ====================
document.getElementById('refresh-verification')?.addEventListener('click', () => {
    generateVerificationCode();
    document.getElementById('verification-input').value = '';
    showToast('Verification code refreshed', 'info');
});

function validateVerification() {
    const input = document.getElementById('verification-input')?.value.trim();
    if (input !== verificationCode) {
        showToast('Incorrect verification code. Please try again.', 'danger');
        generateVerificationCode();
        document.getElementById('verification-input').value = '';
        return false;
    }
    return true;
}

// ==================== Form Submission ====================
document.getElementById('contact-form')?.addEventListener('submit', async function(e) {
    e.preventDefault();

    // Cooldown check (frontend)
    const lastSend = localStorage.getItem(COOLDOWN_KEY);
    if (lastSend) {
        const diff = Date.now() - parseInt(lastSend);
        if (diff < COOLDOWN_MS) {
            const remain = COOLDOWN_MS - diff;
            const m = Math.floor(remain / 60000);
            const s = Math.floor((remain % 60000) / 1000);
            const timeText = m > 0 ? `${m}m ${s}s` : `${s}s`;
            showToast(`Please wait ${timeText} before sending again.`, 'warning');
            return;
        }
    }

    // Basic frontend validation
    if (!this.checkValidity()) {
        showToast('Please complete all required fields.', 'danger');
        this.reportValidity();
        return;
    }

    // Verify captcha
    if (!validateVerification()) return;

    // Collect data
    const payload = {
        name: document.getElementById('contact-name').value.trim(),
        email: document.getElementById('contact-email').value.trim(),
        whatsapp: document.getElementById('contact-whatsapp').value.trim() || '',
        subject: document.getElementById('contact-subject').value.trim(),
        message: document.getElementById('contact-message').value.trim()
    };

    // UI feedback
    const btn = document.getElementById('send-contact-btn');
    const spinner = btn.querySelector('.spinner-border');
    btn.disabled = true;
    spinner.classList.remove('d-none');
    btn.textContent = 'Sending...';

    try {
        const res = await fetch('/contact/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const data = await res.json();

        if (res.ok && data.success) {
            showToast(data.message || 'Your message has been sent successfully! We will reply soon.', 'success');
            localStorage.setItem(COOLDOWN_KEY, Date.now().toString());
            generateVerificationCode();
            document.getElementById('verification-input').value = '';
            this.reset();
        } else {
            showToast(data.message || 'Failed to send message. Please try again.', 'danger');
        }
    } catch (err) {
        console.error('Contact form error:', err);
        showToast('Network error. Please check your connection and try again.', 'danger');
    } finally {
        btn.disabled = false;
        spinner.classList.add('d-none');
        btn.textContent = 'Send Message';
    }
});

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    generateVerificationCode();
});
</script>
{% endblock %}
